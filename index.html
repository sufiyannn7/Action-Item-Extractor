<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Action Item Extractor | Zero-Cost AI</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for Data Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
                    colors: {
                        glass: {
                            100: 'rgba(255, 255, 255, 0.1)',
                            200: 'rgba(255, 255, 255, 0.2)',
                            300: 'rgba(255, 255, 255, 0.3)',
                            dark: 'rgba(15, 23, 42, 0.6)'
                        }
                    },
                    backdropBlur: {
                        xs: '2px',
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s infinite',
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #0f172a;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            color: #f8fafc;
            overflow-x: hidden;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .glass-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 100%);
            border: 1px solid rgba(255,255,255,0.05);
            backdrop-filter: blur(4px);
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            height: 250px;
            margin: 0 auto;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }

        /* Flow Diagram Animations */
        .flow-line {
            stroke-dasharray: 10;
            animation: dash 1s linear infinite;
        }
        @keyframes dash {
            to { stroke-dashoffset: -20; }
        }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="fixed top-0 w-full z-50 glass-panel border-b border-white/5">
        <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white shadow-lg shadow-indigo-500/20">
                    <i class="fa-solid fa-bolt text-sm"></i>
                </div>
                <span class="font-bold tracking-tight text-lg">Action Item Extractor</span>
            </div>
            <div class="hidden md:flex items-center gap-6 text-sm font-medium text-slate-400">
                <a href="#tool" class="hover:text-white transition-colors">The Tool</a>
                <a href="#analytics" class="hover:text-white transition-colors">Analytics</a>
                <a href="#architecture" class="hover:text-white transition-colors">Architecture</a>
            </div>
            <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 text-xs font-mono">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
                System Online
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <header class="pt-32 pb-16 px-6 max-w-7xl mx-auto text-center">
        <h1 class="text-4xl md:text-6xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-200 via-white to-purple-200 mb-6 animate-float">
            Meeting Intelligence, <br /> Zero Cost.
        </h1>
        <p class="text-slate-400 max-w-2xl mx-auto text-lg mb-8 leading-relaxed">
            A serverless hybrid architecture that converts unstructured voice and text into structured data. 
            Powered by <strong>Web Speech API</strong> and <strong>Pollinations AI</strong> (Free Cloud Model) with instantaneous <strong>Local Fallback</strong>.
        </p>
        <div class="flex flex-wrap justify-center gap-4">
            <a href="#tool" class="px-6 py-3 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white font-semibold shadow-lg shadow-indigo-500/25 transition-all transform hover:-translate-y-1">
                <i class="fa-solid fa-play mr-2"></i> Launch Tool
            </a>
            <a href="#architecture" class="px-6 py-3 rounded-xl glass-card hover:bg-white/5 text-white font-semibold transition-all">
                <i class="fa-solid fa-network-wired mr-2"></i> View Architecture
            </a>
        </div>
    </header>

    <!-- MAIN TOOL SECTION -->
    <section id="tool" class="px-6 pb-20 max-w-7xl mx-auto">
        <!-- Contextual Intro -->
        <div class="mb-6 border-l-4 border-indigo-500 pl-4">
            <h2 class="text-xl font-bold text-white">Interactive Extraction Engine</h2>
            <p class="text-sm text-slate-400 mt-1">This module handles the core logic. It accepts multi-modal input (Text, Voice, File) and routes it through the Hybrid AI engine to produce structured JSON output.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 h-[600px]">
            
            <!-- INPUT PANEL -->
            <div class="glass-panel rounded-2xl flex flex-col overflow-hidden relative">
                <div class="px-6 py-4 border-b border-white/5 flex justify-between items-center bg-white/5">
                    <span class="text-xs font-bold text-indigo-400 uppercase tracking-wider">Input Stream</span>
                    <div class="flex gap-2">
                        <button onclick="triggerFile()" class="p-2 rounded hover:bg-white/10 text-slate-400 hover:text-white transition-colors" title="Upload .txt"><i class="fa-solid fa-upload"></i></button>
                        <input type="file" id="fileInput" class="hidden" onchange="handleFile(this)">
                        <button id="micBtn" onclick="toggleMic()" class="p-2 rounded hover:bg-white/10 text-slate-400 hover:text-red-400 transition-colors" title="Toggle Mic"><i class="fa-solid fa-microphone"></i></button>
                        <button onclick="loadSample()" class="px-3 py-1 rounded bg-indigo-500/20 text-indigo-300 text-xs hover:bg-indigo-500/30 transition-colors">Sample</button>
                    </div>
                </div>
                <div class="flex-1 relative group">
                    <textarea id="transcript" class="w-full h-full bg-transparent p-6 text-slate-300 resize-none focus:outline-none font-mono text-sm leading-relaxed" placeholder="// Paste meeting notes or start speaking..."></textarea>
                    <div id="micStatus" class="hidden absolute bottom-4 right-4 px-3 py-1 rounded-full bg-red-500/20 text-red-400 text-xs font-bold border border-red-500/30 items-center gap-2 backdrop-blur-md">
                        <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span> REC
                    </div>
                </div>
                <div class="p-4 border-t border-white/5 bg-white/5">
                    <button onclick="processHybrid()" id="processBtn" class="w-full py-3 rounded-xl bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-semibold shadow-lg hover:shadow-indigo-500/20 transition-all flex justify-center items-center gap-2">
                        <i class="fa-solid fa-wand-magic-sparkles"></i> Process Data
                    </button>
                </div>
            </div>

            <!-- OUTPUT PANEL -->
            <div class="glass-panel rounded-2xl flex flex-col overflow-hidden relative">
                <div class="px-6 py-4 border-b border-white/5 flex justify-between items-center bg-white/5">
                    <span class="text-xs font-bold text-emerald-400 uppercase tracking-wider">Structured Output</span>
                    <div class="flex gap-2">
                        <button onclick="addManual()" class="p-2 rounded hover:bg-white/10 text-slate-400 hover:text-white" title="Add Item"><i class="fa-solid fa-plus"></i></button>
                        <button onclick="copyAll()" class="p-2 rounded hover:bg-white/10 text-slate-400 hover:text-white" title="Copy JSON"><i class="fa-regular fa-copy"></i></button>
                        <button onclick="reset()" class="p-2 rounded hover:bg-white/10 text-slate-400 hover:text-red-400" title="Clear"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto p-6 relative">
                    <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center text-slate-600">
                        <i class="fa-solid fa-cube text-4xl mb-4 opacity-50"></i>
                        <p class="text-sm">No data extracted yet.</p>
                    </div>
                    <div id="loader" class="hidden absolute inset-0 flex flex-col items-center justify-center bg-slate-900/80 backdrop-blur-sm z-10">
                        <div class="w-12 h-12 border-4 border-indigo-500/30 border-t-indigo-500 rounded-full animate-spin mb-4"></div>
                        <p class="text-indigo-400 text-xs font-mono animate-pulse" id="loaderText">CONNECTING TO CLOUD...</p>
                    </div>
                    <div id="results" class="space-y-3"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- LIVE ANALYTICS SECTION (Chart.js) -->
    <section id="analytics" class="px-6 pb-20 max-w-7xl mx-auto">
        <div class="mb-6 border-l-4 border-purple-500 pl-4">
            <h2 class="text-xl font-bold text-white">Live Data Analysis</h2>
            <p class="text-sm text-slate-400 mt-1">Real-time visualization of the extracted data. This demonstrates the application's ability to parse unstructured text into quantifiable metrics suitable for dashboards.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Chart 1: Task Distribution -->
            <div class="glass-panel p-6 rounded-2xl flex flex-col items-center">
                <h3 class="text-sm font-semibold text-slate-300 mb-4 w-full text-left">Task Distribution by Owner</h3>
                <div class="chart-container">
                    <canvas id="ownerChart"></canvas>
                </div>
            </div>

            <!-- Chart 2: AI Confidence/Metrics -->
            <div class="glass-panel p-6 rounded-2xl flex flex-col items-center">
                <h3 class="text-sm font-semibold text-slate-300 mb-4 w-full text-left">Processing Logic & Stats</h3>
                <div class="w-full h-full flex flex-col justify-center space-y-4">
                    <div class="flex justify-between items-center p-3 rounded bg-white/5">
                        <span class="text-sm text-slate-400">Current Engine</span>
                        <span id="statEngine" class="text-sm font-mono text-emerald-400">Idle</span>
                    </div>
                    <div class="flex justify-between items-center p-3 rounded bg-white/5">
                        <span class="text-sm text-slate-400">Total Tasks</span>
                        <span id="statTotal" class="text-sm font-mono text-white">0</span>
                    </div>
                    <div class="flex justify-between items-center p-3 rounded bg-white/5">
                        <span class="text-sm text-slate-400">Time Indicators Found</span>
                        <span id="statDates" class="text-sm font-mono text-indigo-400">0</span>
                    </div>
                    <!-- Simple progress bar for visual flair -->
                    <div class="w-full bg-slate-700 rounded-full h-1.5 mt-2">
                        <div id="statBar" class="bg-gradient-to-r from-indigo-500 to-purple-500 h-1.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- ARCHITECTURE DIAGRAM SECTION -->
    <section id="architecture" class="px-6 pb-20 max-w-7xl mx-auto">
        <div class="mb-6 border-l-4 border-emerald-500 pl-4">
            <h2 class="text-xl font-bold text-white">Zero-Cost Hybrid Architecture</h2>
            <p class="text-sm text-slate-400 mt-1">A visual representation of the data flow. The system prioritizes the free Cloud API for accuracy but maintains a redundant Local Engine for 100% reliability.</p>
        </div>

        <div class="glass-panel p-8 rounded-2xl relative overflow-hidden">
            <!-- Diagram using HTML/Tailwind Grid -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 items-center relative z-10 text-center">
                
                <!-- Step 1: Input -->
                <div class="flex flex-col items-center group">
                    <div class="w-16 h-16 rounded-2xl bg-indigo-500/20 border border-indigo-500/50 flex items-center justify-center text-indigo-400 text-2xl mb-4 shadow-[0_0_15px_rgba(99,102,241,0.3)]">
                        <i class="fa-solid fa-microphone-lines"></i>
                    </div>
                    <h4 class="font-bold text-white">Web Speech API</h4>
                    <p class="text-xs text-slate-400 mt-2">Browser Native<br>No Keys Required</p>
                </div>

                <!-- Connector -->
                <div class="hidden md:flex justify-center text-slate-600 text-xl">
                    <i class="fa-solid fa-arrow-right animate-pulse"></i>
                </div>

                <!-- Step 2: Router (The Hybrid Logic) -->
                <div class="flex flex-col items-center">
                    <div class="p-4 rounded-2xl glass-card border border-white/10 w-full max-w-xs relative">
                        <div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-slate-900 px-3 text-[10px] text-slate-400 uppercase tracking-wide border border-white/10 rounded-full">Hybrid Router</div>
                        
                        <!-- Path A -->
                        <div class="flex items-center justify-between p-2 mb-2 rounded bg-emerald-500/10 border border-emerald-500/20">
                            <span class="text-xs text-emerald-400">Primary: Pollinations AI</span>
                            <i class="fa-solid fa-cloud text-emerald-400 text-xs"></i>
                        </div>
                        
                        <!-- Path B -->
                        <div class="flex items-center justify-between p-2 rounded bg-indigo-500/10 border border-indigo-500/20">
                            <span class="text-xs text-indigo-400">Failover: Local Regex</span>
                            <i class="fa-solid fa-microchip text-indigo-400 text-xs"></i>
                        </div>
                    </div>
                </div>

                <!-- Connector -->
                <div class="hidden md:flex justify-center text-slate-600 text-xl">
                    <i class="fa-solid fa-arrow-right animate-pulse"></i>
                </div>

                <!-- Step 3: Output -->
                <div class="flex flex-col items-center">
                    <div class="w-16 h-16 rounded-2xl bg-purple-500/20 border border-purple-500/50 flex items-center justify-center text-purple-400 text-2xl mb-4 shadow-[0_0_15px_rgba(168,85,247,0.3)]">
                        <i class="fa-solid fa-list-check"></i>
                    </div>
                    <h4 class="font-bold text-white">Structured JSON</h4>
                    <p class="text-xs text-slate-400 mt-2">Rendered via DOM<br>Persisted Locally</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-800 border border-white/10 px-6 py-3 rounded-full shadow-2xl transform translate-y-24 opacity-0 transition-all duration-300 flex items-center gap-3 z-50">
        <i class="fa-solid fa-circle-check text-emerald-400"></i>
        <span id="toastMsg" class="text-sm font-medium text-white">Notification</span>
    </div>

    <script>
        // --- DATA & STATE ---
        const sampleText = `Meeting: Q4 Product Launch
Attendees: Sarah (PM), Mike (Eng), Jessica (Design)

Sarah: Let's confirm the plan. We need to finalize the PRD by Friday.
Mike: I will check the API feasibility tomorrow.
Jessica: I am going to update the Figma mocks before the weekend.
Sarah: Mike, please schedule the demo for next Tuesday.
Jessica: Also, we must fix the login bug immediately.`;

        let taskData = []; // Store extracted items for chart
        let recognition = null;
        let isRecording = false;
        let explicitStop = false;

        // --- DOM ELEMENTS ---
        const transcriptEl = document.getElementById('transcript');
        const resultsEl = document.getElementById('results');
        const emptyEl = document.getElementById('emptyState');
        const loaderEl = document.getElementById('loader');
        const loaderText = document.getElementById('loaderText');
        const micStatus = document.getElementById('micStatus');
        
        // --- CHART INITIALIZATION ---
        let ownerChartInstance = null;

        function initCharts() {
            const ctx = document.getElementById('ownerChart').getContext('2d');
            ownerChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Unassigned'],
                    datasets: [{
                        data: [1],
                        backgroundColor: ['#475569'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { color: '#94a3b8', font: { size: 10, family: 'Plus Jakarta Sans' } } }
                    },
                    cutout: '70%'
                }
            });
        }

        function updateCharts(items) {
            // Process data for Chart.js
            const ownerCounts = {};
            let datesFound = 0;

            items.forEach(item => {
                const owner = item.owner || "Unassigned";
                ownerCounts[owner] = (ownerCounts[owner] || 0) + 1;
                if(item.deadline && item.deadline !== "No Date") datesFound++;
            });

            // Update Doughnut Chart
            const labels = Object.keys(ownerCounts);
            const data = Object.values(ownerCounts);
            // Generate colors
            const colors = labels.map((_, i) => `hsl(${220 + (i * 30)}, 70%, 60%)`);

            ownerChartInstance.data.labels = labels;
            ownerChartInstance.data.datasets[0].data = data;
            ownerChartInstance.data.datasets[0].backgroundColor = colors;
            ownerChartInstance.update();

            // Update Stats Panel
            document.getElementById('statTotal').innerText = items.length;
            document.getElementById('statDates').innerText = datesFound;
            document.getElementById('statBar').style.width = '100%';
        }

        // --- LOCAL ENGINE (Regex Logic) ---
        class LocalEngine {
            constructor() {
                this.verbs = ["will", "needs to", "must", "going to", "should", "can you", "please", "schedule", "fix", "update", "create"];
                this.timeWords = ["by", "on", "before", "until", "tomorrow", "today", "friday", "monday", "tuesday", "wednesday", "thursday", "weekend", "week"];
                this.people = ["I", "You", "We", "Sarah", "Mike", "Jessica", "John", "Team", "Devs"];
            }

            analyze(text) {
                const sentences = text.split(/[.!?\n]+/).filter(s => s.trim().length > 10);
                const results = [];
                sentences.forEach(s => {
                    const clean = s.trim();
                    const lower = clean.toLowerCase();
                    if (this.verbs.some(v => lower.includes(v))) {
                        results.push({
                            task: clean,
                            owner: this.extract(clean, this.people) || "Unassigned",
                            deadline: this.extract(clean, this.timeWords, true) || "No Date",
                            source: "Local Engine"
                        });
                    }
                });
                return results;
            }

            extract(text, list, isTime = false) {
                const lower = text.toLowerCase();
                for (let word of list) {
                    if (lower.includes(word.toLowerCase())) {
                        if(isTime) {
                            const idx = lower.indexOf(word.toLowerCase());
                            return text.substring(idx, idx + 15).trim() + "...";
                        }
                        return word;
                    }
                }
                return null;
            }
        }

        // --- HYBRID PROCESSING FLOW ---
        async function processHybrid() {
            const text = transcriptEl.value.trim();
            if (!text) return showToast("Please enter text first", "error");

            // UI Reset
            emptyEl.classList.add('hidden');
            resultsEl.innerHTML = '';
            loaderEl.classList.remove('hidden');
            
            const localEngine = new LocalEngine();
            let items = [];
            let source = "";

            try {
                // 1. Try Cloud (Pollinations AI - Free)
                loaderText.innerText = "CONNECTING TO POLLINATIONS AI...";
                
                // Extremely strict prompt for the free model
                const prompt = `You are a machine that outputs JSON only.
Task: Extract action items from the following meeting transcript.
Transcript: "${text}"
Format: A single valid JSON array of objects. Keys: "task", "owner", "deadline".
Example: [{"task": "Fix bug", "owner": "Mike", "deadline": "Friday"}]
Return ONLY the JSON array.`;

                const res = await fetch(`https://text.pollinations.ai/${encodeURIComponent(prompt)}?seed=${Date.now()}&model=openai`);
                if(!res.ok) throw new Error("Cloud Fail");
                
                const raw = await res.text();
                // Clean markdown if present
                const jsonStr = raw.replace(/```json|```/g, '').trim();
                const match = jsonStr.match(/\[.*\]/s);
                const cleanJson = match ? match[0] : jsonStr;
                
                items = JSON.parse(cleanJson).map(i => ({...i, source: "Cloud AI"}));
                source = "Cloud AI (Pollinations)";
                
            } catch (e) {
                // 2. Failover to Local
                console.warn("Cloud failed, switching to local", e);
                loaderText.innerText = "CLOUD BUSY. SWITCHING TO LOCAL ENGINE...";
                await new Promise(r => setTimeout(r, 800)); // Visible delay for effect
                items = localEngine.analyze(text);
                source = "Local Engine (Edge)";
            }

            // Render Results
            loaderEl.classList.add('hidden');
            document.getElementById('statEngine').innerText = source;
            
            if (items.length === 0) {
                resultsEl.innerHTML = `<div class="text-center text-slate-500 py-4">No actionable tasks found.</div>`;
            } else {
                items.forEach((item, i) => createCard(item, i));
                updateCharts(items);
                showToast(`Extracted ${items.length} items via ${source.split(' ')[0]}`, "success");
            }
        }

        // --- UI FUNCTIONS ---
        function createCard(item, index) {
            const isCloud = item.source.includes("Cloud");
            const div = document.createElement('div');
            div.className = `glass-card p-4 rounded-xl border-l-4 ${isCloud ? 'border-l-emerald-500' : 'border-l-indigo-500'} animate-float`;
            div.style.animation = `fadeIn 0.5s ease forwards ${index * 0.1}s`;
            
            div.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <p class="text-sm text-slate-200 font-medium flex-1 mr-2" contenteditable="true">${item.task}</p>
                    <span class="text-[10px] px-2 py-0.5 rounded border ${isCloud ? 'bg-emerald-500/10 border-emerald-500/20 text-emerald-400' : 'bg-indigo-500/10 border-indigo-500/20 text-indigo-400'}">
                        ${isCloud ? '<i class="fa-solid fa-cloud"></i>' : '<i class="fa-solid fa-microchip"></i>'}
                    </span>
                </div>
                <div class="flex gap-2 mt-2">
                    <span class="text-[10px] bg-white/5 px-2 py-1 rounded text-slate-400 flex items-center gap-1">
                        <i class="fa-solid fa-user text-xs"></i> ${item.owner || 'Unassigned'}
                    </span>
                    <span class="text-[10px] bg-white/5 px-2 py-1 rounded text-slate-400 flex items-center gap-1">
                        <i class="fa-regular fa-clock text-xs"></i> ${item.deadline || 'No Date'}
                    </span>
                </div>
            `;
            resultsEl.appendChild(div);
        }

        // --- UTILITIES ---
        function loadSample() {
            transcriptEl.value = sampleText;
            showToast("Sample loaded");
        }

        function triggerFile() { document.getElementById('fileInput').click(); }
        
        function handleFile(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => { transcriptEl.value = e.target.result; showToast("File imported"); };
            reader.readAsText(file);
        }

        function toggleMic() {
            if (!('webkitSpeechRecognition' in window)) return alert("Browser does not support Speech API");
            const btn = document.getElementById('micBtn');
            
            if(!recognition) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.onstart = () => {
                    isRecording = true;
                    btn.classList.replace('text-slate-400', 'text-red-500');
                    micStatus.classList.remove('hidden');
                    micStatus.classList.add('flex');
                };
                recognition.onend = () => {
                    if(!explicitStop && isRecording) recognition.start(); // Sticky
                    else {
                        isRecording = false;
                        btn.classList.replace('text-red-500', 'text-slate-400');
                        micStatus.classList.add('hidden');
                        micStatus.classList.remove('flex');
                    }
                };
                recognition.onresult = (e) => {
                    let final = '';
                    for (let i = e.resultIndex; i < e.results.length; ++i) {
                        if (e.results[i].isFinal) final += e.results[i][0].transcript + ' ';
                    }
                    if (final) {
                        transcriptEl.value += final;
                        transcriptEl.scrollTop = transcriptEl.scrollHeight;
                    }
                };
            }

            if(isRecording) {
                explicitStop = true;
                isRecording = false;
                recognition.stop();
                showToast("Microphone stopped");
            } else {
                explicitStop = false;
                recognition.start();
                showToast("Listening...");
            }
        }

        function addManual() {
            createCard({task: "New Task...", owner: "Me", deadline: "Today", source: "Local Manual"}, 0);
            emptyEl.classList.add('hidden');
        }

        function copyAll() {
            const text = Array.from(document.querySelectorAll('#results p')).map(p => `- [ ] ${p.innerText}`).join('\n');
            navigator.clipboard.writeText(text).then(() => showToast("Copied to clipboard"));
        }

        function reset() {
            transcriptEl.value = '';
            resultsEl.innerHTML = '';
            emptyEl.classList.remove('hidden');
            // Reset Chart
            if(ownerChartInstance) {
                ownerChartInstance.data.labels = ['Unassigned'];
                ownerChartInstance.data.datasets[0].data = [1];
                ownerChartInstance.data.datasets[0].backgroundColor = ['#475569'];
                ownerChartInstance.update();
            }
            document.getElementById('statTotal').innerText = "0";
            document.getElementById('statDates').innerText = "0";
            document.getElementById('statEngine').innerText = "Idle";
            document.getElementById('statBar').style.width = "0%";
        }

        function showToast(msg, type="info") {
            const toast = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            toast.classList.remove('translate-y-24', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-24', 'opacity-0'), 3000);
        }

        // Init
        window.onload = initCharts;

    </script>
</body>
</html>
